name: ci-build-services

on:
  push:
    branches:
      - main
  workflow_dispatch:   # optional manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  detect-and-build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Detect changed folders under src/*
      - name: Detect changed services
        id: detect
        run: |
          echo "CHANGED_SERVICES<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~1 HEAD | grep '^src/' | cut -d'/' -f2 | sort | uniq >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. If nothing changed, exit fast
      - name: Stop if nothing changed
        if: ${{ steps.detect.outputs.CHANGED_SERVICES == '' }}
        run: echo "No services changed. Skip build." && exit 0

      # 4. Log in to Azure using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 5. Login to ACR
      - name: ACR Login
        run: az acr login --name acrweek3

      # 6. Build + push each changed service
      - name: Build & Push changed services
        run: |
          for svc in ${{ steps.detect.outputs.CHANGED_SERVICES }}; do
            echo "Building $svc..."
            docker build \
              -t acrweek3.azurecr.io/$svc:dev-${{ github.sha }} \
              ./src/$svc

            echo "Pushing $svc..."
            docker push acrweek3.azurecr.io/$svc:dev-${{ github.sha }}
          done
