name: ci-build-services

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Detect changed services under src/*
      - name: Detect changed services
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^src/' | cut -d'/' -f2 | sort -u || true)
          
          # remove blank lines
          CLEANED=$(echo "$CHANGED" | sed '/^\s*$/d')

          echo "changed=$CLEANED" >> $GITHUB_OUTPUT

      - name: Stop if nothing changed
        if: ${{ steps.detect.outputs.changed == '' }}
        run: echo "No services changed. Skipping build."

      # Only runs if something changed
      - name: Azure Login
        if: ${{ steps.detect.outputs.changed != '' }}
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR Login
        if: ${{ steps.detect.outputs.changed != '' }}
        run: az acr login --name acrweek3

      - name: Build & Push changed services
        if: ${{ steps.detect.outputs.changed != '' }}
        run: |
          for svc in ${{ steps.detect.outputs.changed }}; do
            echo "Building $svc"
            docker build -t acrweek3.azurecr.io/$svc:dev-${{ github.sha }} ./src/$svc

            echo "Pushing $svc"
            docker push acrweek3.azurecr.io/$svc:dev-${{ github.sha }}
          done

      # Store list of changed services as artifact for CD
      - name: Create artifact
        if: ${{ steps.detect.outputs.changed != '' }}
        run: |
          echo "${{ steps.detect.outputs.changed }}" > changed_services.txt

      - name: Upload artifact
        if: ${{ steps.detect.outputs.changed != '' }}
        uses: actions/upload-artifact@v3
        with:
          name: changed-services
          path: changed_services.txt
