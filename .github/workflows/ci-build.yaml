name: ci-build-services

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-and-build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # ensure HEAD~1 exists

      # 2. Detect changed folders under src/*
      - name: Detect changed services
        id: detect
        run: |
          echo "CHANGED_SERVICES<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~1 HEAD | grep '^src/' | cut -d'/' -f2 | sort | uniq >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. Exit early if nothing changed
      - name: Stop if nothing changed
        if: ${{ steps.detect.outputs.CHANGED_SERVICES == '' }}
        run: echo "No services changed. Skip build." && exit 0

      # 4. Azure Login (OIDC)
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 5. Login to ACR
      - name: ACR Login
        run: az acr login --name acrweek3

      # 6. Build + push each changed service (kebab-case folder names)
      - name: Build & Push changed services
        run: |
          for folder in ${{ steps.detect.outputs.CHANGED_SERVICES }}; do
            echo "Building image for $folder..."
            docker build \
              -t acrweek3.azurecr.io/$folder:dev-${{ github.sha }} \
              ./src/$folder

            echo "Pushing image for $folder..."
            docker push acrweek3.azurecr.io/$folder:dev-${{ github.sha }}
          done

      # 7. Create deployment artifact (folder → helmKey mapping)
      - name: Create deployment artifact
        run: |
          echo "Creating artifact..."

          # Mapping from folder name → Helm values.yaml key
          declare -A map=(
            ["ai-service"]="aiService"
            ["makeline-service"]="makelineService"
            ["order-service"]="orderService"
            ["product-service"]="productService"
            ["store-admin"]="storeAdmin"
            ["store-front"]="storeFront"
            ["virtual-customer"]="virtualCustomer"
            ["virtual-worker"]="virtualWorker"
          )

          # convert space-separated list to newline list
          echo "${{ steps.detect.outputs.CHANGED_SERVICES }}" | tr ' ' '\n' > changed.txt

          # create artifact file
          rm -f changed-services.txt
          while read folder; do
            svc=${map[$folder]}
            echo "$svc=dev-${{ github.sha }}" >> changed-services.txt
          done < changed.txt

      # 8. Upload artifact for CD to consume
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: changed-services
          path: changed-services.txt
