name: ci-build-services

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-build-upload:
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout full history (needed for diff)
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Detect changed services under src/*
      - name: Detect changed services
        id: detect
        run: |
          echo "Detecting folder changes…"
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^src/' | cut -d'/' -f2 | sort | uniq || true)
          
          echo "Changed services:"
          echo "$CHANGED"

          # expose as output (multiline)
          echo "CHANGED_SERVICES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. Skip if no change
      - name: Stop if nothing changed
        if: ${{ steps.detect.outputs.CHANGED_SERVICES == '' }}
        run: echo "No services changed. Skip build." && exit 0

      # 4. Login to Azure using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 5. Login to ACR
      - name: ACR Login
        run: az acr login --name acrweek3

      # 6. Build & Push images
      - name: Build & Push changed services
        id: push
        run: |
          echo "Building & pushing…"

          mkdir -p artifacts   # temp folder for metadata

          while IFS= read -r svc; do
            echo "Processing: $svc"

            IMAGE="acrweek3.azurecr.io/$svc:dev-${{ github.sha }}"

            docker build -t $IMAGE ./src/$svc
            docker push $IMAGE

            # Save artifact so CD knows what changed
            echo "$svc=$IMAGE" >> artifacts/images.txt

          done <<< "${{ steps.detect.outputs.CHANGED_SERVICES }}"

      # 7. Upload the artifact for CD workflow
      - name: Upload Changed Image List
        uses: actions/upload-artifact@v4
        with:
          name: changed-images
          path: artifacts/images.txt
